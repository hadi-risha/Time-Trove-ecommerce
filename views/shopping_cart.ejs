<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <!-- font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    integrity="sha384-k6RqeT8HML5Amx6YeHdCeZpMVO8Tz2plkgwEe1UwWj5IiiMvVq/ZqCkrItjR5AaQ" crossorigin="anonymous">
    
    <!-- css -->
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="/css/shopping_cart.css">
    <!-- bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>

    <!-- header section -->
    <header class="head-section">
        <div class="container-fluid">
            <div class="row p-0">
                <div class="col-12 m-0 head-section d-flex align-items-center p-0">


                    <!-- logo  -->
                    <a href="/">
                    <svg class="logo" width="115" height="115" viewBox="0 0 115 115" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M31 90.44C26.7867 90.44 23.8267 89.1867 22.12 86.68C21.5333 85.88 21.24 84.84 21.24 83.56C21.24 82.12 21.6933 80.8667 22.6 79.8C23.6667 78.5733 25 77.96 26.6 77.96C27.6667 77.96 28.52 78.3333 29.16 79.08C29.7467 79.6667 30.04 80.4667 30.04 81.48C30.04 82.76 29.5867 83.8 28.68 84.6C27.7733 85.3467 26.8133 85.72 25.8 85.72C24.8933 85.72 24.0667 85.4 23.32 84.76C24.2267 86.7867 25.8533 87.8 28.2 87.8C33.6933 87.8 38.84 84.2267 43.64 77.08C44.8667 75.32 46.0667 73.48 47.24 71.56C48.4133 69.5867 49.5867 67.5333 50.76 65.4C51.8267 63.3733 52.8933 61.3467 53.96 59.32C55.0267 57.2933 56.0933 55.2667 57.16 53.24C61.5333 44.9733 66.36 40.0667 71.64 38.52C69.6133 38.2533 67.5867 37.96 65.56 37.64C63.5867 37.32 61.5867 37 59.56 36.68C57.16 36.3067 54.9467 36.04 52.92 35.88C50.9467 35.72 49.1867 35.64 47.64 35.64C41.3467 35.64 36.2533 36.9467 32.36 39.56C30.12 41.0533 28.3333 42.8667 27 45C25.6133 47.1867 24.92 49.2933 24.92 51.32C24.92 56.0133 28.0667 58.36 34.36 58.36C36.4933 58.36 38.6267 57.96 40.76 57.16C42.8933 56.3067 45.08 55.1067 47.32 53.56C49.1867 52.1733 50.92 50.6267 52.52 48.92C54.12 47.16 55.5333 45.2133 56.76 43.08C57.0267 42.6533 57.3733 42.44 57.8 42.44C58.44 42.44 58.6267 42.68 58.36 43.16C57.2933 45.6133 55.9867 47.8533 54.44 49.88C52.8933 51.8533 51.08 53.6133 49 55.16C44.7333 58.2533 40.0133 59.8 34.84 59.8C32.5467 59.8 30.4933 59.5067 28.68 58.92C26.8667 58.28 25.3467 57.32 24.12 56.04C22.0933 53.9067 21.08 51.3467 21.08 48.36C21.08 45.7467 21.88 43.2133 23.48 40.76C25.08 38.2533 27.3467 36.2533 30.28 34.76C35.08 32.4133 40.3867 31.24 46.2 31.24C48.28 31.24 50.7867 31.4267 53.72 31.8C56.6533 32.1733 60.0133 32.7333 63.8 33.48C68.8667 34.4933 73.0267 35.24 76.28 35.72C79.5333 36.2 81.88 36.44 83.32 36.44C86.4667 36.44 89 35.88 90.92 34.76C91.24 34.6 91.5067 34.52 91.72 34.52C92.04 34.52 92.2 34.7333 92.2 35.16C92.2 35.5333 91.9867 35.8533 91.56 36.12C88.04 38.52 83.5867 39.56 78.2 39.24L75.64 39C70.52 39.5867 66.28 44.0133 62.92 52.28C58.44 63.2133 55.7733 69.5067 54.92 71.16C51.3467 78.0933 47.1067 83.32 42.2 86.84C38.84 89.24 35.1067 90.44 31 90.44ZM76.2094 87C72.7427 87 71.0094 85.1067 71.0094 81.32C71.0094 80.5733 71.0627 79.8 71.1694 79C71.3294 78.2 71.5694 77.4 71.8894 76.6C74.716 69.1333 77.116 63.0533 79.0894 58.36H73.8894L74.8494 56.6H79.8094L81.7294 51C82.4227 49.0267 83.0094 47.8533 83.4894 47.48C83.8627 47.2133 84.716 47.08 86.0494 47.08L89.4894 47.16C88.4227 48.0667 87.6227 49.16 87.0894 50.44L84.4494 56.6H90.5294L89.5694 58.36H83.7294C83.356 59.2133 82.9827 60.0667 82.6094 60.92C82.2894 61.7733 81.916 62.6533 81.4894 63.56C80.3694 66.0133 79.4094 68.3333 78.6094 70.52C77.6494 73.0267 76.876 75.1867 76.2894 77C75.756 78.8133 75.436 80.2533 75.3294 81.32C75.116 83.9333 75.8094 85.24 77.4094 85.24C78.9027 85.24 80.716 83.64 82.8494 80.44L83.8094 81.56C81.2494 85.1867 78.716 87 76.2094 87Z"
                            fill="#FDFFA8" />
                        <path
                            d="M57.55 114.1C88.7817 114.1 114.1 88.7817 114.1 57.55C114.1 26.3183 88.7817 1 57.55 1C26.3183 1 1 26.3183 1 57.55C1 88.7817 26.3183 114.1 57.55 114.1Z"
                            stroke="#F1F5D9" stroke-width="1.38095" stroke-linecap="round" stroke-linejoin="round" />
                    </svg></a>
                    <!-- /logo -->
                    <!-- icons -->
                    <div class="icons">
                        <ul class="useroption p-0 m-0 d-flex align-items-center list-unstyled">
                            <li>
                                <a href="#" class="search">
                                    <span class="search-icon"><i class="fa fa-search" aria-hidden="true"></i></span>
                                </a>
                                <div class="search-box" style="display: none;">
                                    <button type="button" class="search-close"><i class="fa fa-times" aria-hidden="true"></i> Close</button>
                                    <input id="searchInput" style="color: rgb(0, 0, 0);" type="text"  autocomplete="off" class="search-input" placeholder="Search for products,brands and more">
                                    <button type="submit" class="search-submit"><i class="fa fa-arrow-right" aria-hidden="true"></i></button>
                                </div>
                            </li>

                            <!-- container to show search results -->
                            <div id="searchResults" class="search-results"></div>
                            <!-- /container to show search results -->

                            
                            <li>
                                <div class="dropdown">
                                    <a  class="person">
                                        <span><svg class="person-icon "  xmlns="http://www.w3.org/2000/svg"  fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16">
                                            <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
                                        </svg></span>
                                        <!-- <i class="bi bi-person-fill"></i> -->
                                    </a>

                                    <!-- Dropdown Content -->
                                    <% if(userLoggined){ %>
                                    <div class="dropdown-content" id="dropdownContent">
                                        <p  class="name-text">Hello <%= userName %></p>
                                        <div class="dropdown-line1"></div>
                                        <a href="/user-profile" style="color: black;">Profile</a>
                                        <a href="/orders" style="color: black;">Orders</a>
                                        <a href="#" style="color: black;">Wishlist</a>
                                        <a href="#" style="color: black;">Saved Addresses</a>
                                        <a href="#" style="color: black;">Edit Profile</a>
                                        <a href="/forgot-password" style="color: black;">Reset password</a>
                                        <div class="dropdown-line2"></div>
                                        <!-- user logout button -->
                                        <a href="#" style="color: black;">
                                            <form action="/user-logout" method="post">
                                                <button class="logOut-btn">Logout</button>
                                            </form>
                                        </a>
                                        <!-- end of user logout button -->
                                    </div>
                                <% }else{ %>
                                    <div class="dropdown-content" id="dropdownContent">
                                        <p class="name-text">Welcome</p>
                                        <!-- <p style="font-size: 13px;">To access account and manage orders</p> -->
                                        <a href="/user-login"><p class="login-signup">LOGIN / SIGNUP</p></a>
                                        <div class="dropdown-line1"></div>
                                        <a href="/user-login" style="color: black;">Profile</a>
                                        <a href="/user-login" style="color: black;">Orders</a>
                                        <a href="/user-login" style="color: black;">Wishlist</a>
                                        <a href="/user-login" style="color: black;">Saved Addresses</a>
                                        <a href="/user-login" style="color: black;">Edit Profile</a>
                                    </div>
                                <% } %>
                                </div>

                                <script>
                                    // Function to toggle the dropdown content
                                    function toggleDropdown() {
                                        var dropdownContent = document.getElementById("dropdownContent");
                                        dropdownContent.style.display = (dropdownContent.style.display === "block") ? "none" : "block";
                                    }
                                </script>

                            </li>
                            <li>
                                <!-- show cart count -->
                                <% if(cartCount > 0 && userLoggined){ %>
                                    <div style="background-color: rgb(208, 11, 11); width: 14px; height: 16px; border-radius: 20px;
                                            position: absolute; color: white; padding: 2px; left: 88.4vw; top: 37;">
                                        <p style="    margin-top: -3px;
                                        margin-bottom: 1rem;
                                        font-size: 12px;
                                    "><%= cartCount %></p>
                                    </div>
                                <% }else{ %>
                                    <div style=" display: none; background-color: rgb(208, 11, 11); width: 14px; height: 16px; border-radius: 20px;
                                            position: absolute; color: white; padding: 2px; left: 88.4vw; top: 37;">
                                        <p style="    margin-top: -3px;
                                        margin-bottom: 1rem;
                                        font-size: 12px;
                                    "><%= cartCount %></p>
                                    </div>
                                <% } %>
                                
                                <a href="/shopping-cart" class="cart">
                                    <span class="bag-icon"><i class="fa fa-shopping-bag" aria-hidden="true"></i></span>
                                </a>
                            </li>
                            <li style="margin-left: 10px;">
                                <a href='/wishlist' class="wishlist">
                                    <span class="heart-icon"><i class="fa fa-heart" aria-hidden="true"></i></span>
                                </a>
                            </li>
                        </ul>
                        
                    </div>
                    <!-- /icons -->
                </div>

            </div>
        </div>
    </header>
    <!-- /header section -->



    <!-- main section -->
    <main class="main-container">
        <div class="container-fluid" style="padding: 0 100px;">
            <div class="row p-0">
                <div class="col-12 m-0 p-0">
                    <% if(cartProductDetails.length > 0){ %>
                    <p class="cart-head">Shopping Cart <span>(<%= cartProductDetails.length %>)</span></p>
                    <div class="complete-section">

                        <!-- left side -->
                        <div class="left-Side">
                            
                            <% for(let i=0; i<cartProductDetails.length; i++) { %>
                                <% if (cartProductDetails.length !== 0 ) { %>
                                    <div class="cart-box">
                                        <div class="image-box mt-0">
                                            <img class="og-img" src="<%= cartProductDetails[i]?.pDetails[0]?.images[0] %>">
                                        </div>
                                        <div class="single-data-container">
                                            <p class="brand-name"><%= cartProductDetails[i]?.pDetails[0]?.productName %></p>
                                            <!-- product remove icon -->
                                            <div class="delete">
                                                <form action="/remove-item" method="post" onsubmit="return confirmDelete(event);">
                                                    <button>
                                                        <input type="hidden" name="id" value="<%= cartProductDetails[i].pDetails[0]._id %>">
                                                        <svg class="remove-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M22.81 22.81L1 1M22.81 1L1 22.81" stroke="black" stroke-width="1.38095" stroke-linecap="round" stroke-linejoin="round"/>
                                                        </svg>
                                                    </button>
                                                </form>  
                                            </div>
                                            <!--end of product remove icon -->                         
                                            <p class="pDescription"><%= cartProductDetails[i].pDetails[0].productDescription %></p>

                                            <div class="Qty-Container">
                                                <div class="sample-box1">
                                                    <p class="pSize">Size: Onesize</p>
                                                </div>
                                                
                                                
                                                <!-- quantity section -->
                                                <div class="sample-box2">
                                                <form class="quantity-form" method="post" data-productId="<%= cartProductDetails[i]._id %>">
                                                    <input type="hidden" name="productId" value="<%= cartProductDetails[i].pDetails[0]._id %>">
                                                    <label class="quantity" for="quantity">Qty:</label>

                                                    <!-- normal qty case -->
                                                    <% if (cartProductDetails[i].userAddedQuantity <= cartProductDetails[i].pDetails[0].quantity) { %>
                                                        <button type="button" class="inc-dec" onclick="updateQuantity(-1, '<%= cartProductDetails[i]._id %>')">-</button>
                                                        <input class="no-box" type="number" name="qty" id="quantity_<%= cartProductDetails[i]._id %>" min="1" value="<%= cartProductDetails[i].userAddedQuantity %>" disabled>
                                                        <button type="button" class="inc-dec2" onclick="updateQuantity(1, '<%= cartProductDetails[i]._id %>')">+</button>
                                                    <!-- normal qty case -->  
                                                    <% } else if (cartProductDetails[i].pDetails[0].quantity == 0){ %>
                                                        <!-- quantity = 0 case -->
                                                        <button type="button" disabled  class="inc-dec" onclick="updateQuantity(-1, '<%= cartProductDetails[i]._id %>')">-</button>
                                                        <input class="no-box" type="number" name="qty" id="quantity_<%= cartProductDetails[i]._id %>" min="0" value="<%= cartProductDetails[i].userAddedQuantity %>">
                                                        <button type="button" disabled class="inc-dec2" onclick="updateQuantity(1, '<%= cartProductDetails[i]._id %>')">+</button>
                                                        <span  class="out-of-stock" >Product Out of Stock</span>
                                                        <input type="hidden" name="qty" value="0">
                                                        <!-- /quantity = 0 case -->
                                                    <% } else { %> 
                                                        <!-- limited product available, but user clicked for more qty  -->
                                                        <button type="button"  class="inc-dec" onclick="updateQuantity(-1, '<%= cartProductDetails[i]._id %>')">-</button>
                                                        <input class="no-box" type="number" name="qty" id="quantity_<%= cartProductDetails[i]._id %>" min="1" value="<%= cartProductDetails[i].userAddedQuantity %>">
                                                        <button type="button" disabled class="inc-dec2" onclick="updateQuantity(1, '<%= cartProductDetails[i]._id %>')">+</button>
                                                        <span class="out-of-stock">Quantity limit exceeded.</span>
                                                        <input type="hidden" name="qty" value="0">
                                                        <!-- /limited product available, but user clicked for more qty  -->
                                                    <% } %>

                                                    <p id="qtyLimitExceeded" style="color: red; font-size: 16px;"></p>

                                                </form>
                                                </div>
                                                <!-- end of quantity section -->

                                            </div>




                                            <!-- price section -->
                                            <div class="price-container ">
                                                <!-- both offer exist case -->
                                                <% if(cartProductDetails[i].pDetails[0]?.productofferDiscount && cartProductDetails[i].pDetails[0]?.categoryofferDiscount){ %>
                                                    <% let finalizeDiscount = cartProductDetails[i].pDetails[0].productofferDiscount > cartProductDetails[i].pDetails[0]?.categoryofferDiscount ? cartProductDetails[i].pDetails[0].productofferDiscount :  cartProductDetails[i].pDetails[0]?.categoryofferDiscount %>

                                                    <% let totalDisc = cartProductDetails[i].pDetails[0].discount + finalizeDiscount %>
                                                    <% let disc = (cartProductDetails[i].pDetails[0].firstPrice * totalDisc)/100 %>
                                                    <% let finalAmount = cartProductDetails[i].pDetails[0].firstPrice - disc %>
                                                    <% finalAmount = Math.trunc(finalAmount); %>

                                                    <p class="last-price">Rs. <%= finalAmount %></p>
                                                    <p class="first-price">Rs. <%= cartProductDetails[i].pDetails[0].firstPrice %></p>
                                                    <p class="discount">(<%= cartProductDetails[i].pDetails[0].discount + finalizeDiscount %>% OFF)</p>

                                                    <script>
                                                        console.log('in both offer case');
                                                    </script>
                                                    

                                                    

                                                <!-- only product-offer exist case  -->
                                                <% } else if(cartProductDetails[i].pDetails[0]?.productofferDiscount) { %>

                                                    <% let totalDisc = cartProductDetails[i].pDetails[0].discount + cartProductDetails[i].pDetails[0].productofferDiscount %>
                                                    <% let disc = (cartProductDetails[i].pDetails[0].firstPrice * totalDisc)/100 %>
                                                    <% let finalAmount = cartProductDetails[i].pDetails[0].firstPrice - disc %>
                                                    <% finalAmount = Math.trunc(finalAmount); %>

                                                    <p class="last-price">Rs. <%= finalAmount %></p>
                                                    <p class="first-price">Rs. <%= cartProductDetails[i].pDetails[0].firstPrice %></p>
                                                    <p class="discount">(<%= cartProductDetails[i].pDetails[0].discount + cartProductDetails[i].pDetails[0].productofferDiscount %>% OFF)</p>

                                                    <script>
                                                        console.log('in product offer case');
                                                    </script>

                                                <!-- only category-offer exist case -->
                                                <% } else if(cartProductDetails[i].pDetails[0]?.categoryofferDiscount) { %>

                                                    <% let totalDisc = cartProductDetails[i].pDetails[0].discount + cartProductDetails[i].pDetails[0].categoryofferDiscount %>
                                                    <% let disc = (cartProductDetails[i].pDetails[0].firstPrice * totalDisc)/100 %>
                                                    <% let finalAmount = cartProductDetails[i].pDetails[0].firstPrice - disc %>
                                                    <% finalAmount = Math.trunc(finalAmount); %>

                                                    <p class="last-price">Rs. <%= finalAmount %></p>
                                                    <p class="first-price">Rs. <%= cartProductDetails[i].pDetails[0].firstPrice %></p>
                                                    <p class="discount">(<%= cartProductDetails[i].pDetails[0].discount + cartProductDetails[i].pDetails[0].categoryofferDiscount %>% OFF)</p>

                                                    <script>
                                                        console.log('in cat offer case');
                                                    </script>

                                                <!-- none of these offer exist case -->
                                                <% } else { %>

                                                    <p class="last-price">Rs. <%= cartProductDetails[i].pDetails[0].lastPrice %></p>
                                                    <p class="first-price">Rs. <%= cartProductDetails[i].pDetails[0].firstPrice %></p>
                                                    <p class="discount">(<span><%= cartProductDetails[i].pDetails[0].discount %>% </span>OFF)</p>


                                                    <script>
                                                        console.log('in no-extra offer case');
                                                    </script>
                                                <% } %>

                                            </div>

                                            <!-- /price section -->




                                            <div class="return-container">
                                                <svg class="return-icon" width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M1.42871 27.1433H27.143C30.174 27.1433 33.0809 25.9392 35.2242 23.7959C37.3675 21.6527 38.5716 18.7458 38.5716 15.7147C38.5716 12.6837 37.3675 9.77676 35.2242 7.63348C33.0809 5.49021 30.174 4.28613 27.143 4.28613H18.5716" stroke="black" stroke-width="2.85714" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <path d="M10.0001 18.5723L1.42871 27.1437L10.0001 35.7151" stroke="black" stroke-width="2.85714" stroke-linecap="round" stroke-linejoin="round"/>
                                                    </svg>
                                                                    
                                                <p class="return-txt m-0"><span style="font-weight: bold;">14 days</span> return available</p>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            <% } %>
                        </div>
                        <!-- /left side -->

                        <!-- right side -->
                        <div class="right-Side">
                            <div id="payment-box" class="payment-box">
                                <!-- <form action="product-payment" method="post"> -->
                                    <input type="hidden" name="cartProductIDs" value="<%= cartProductDetails._id %>">
                                    <input type="hidden" name="cartQuantityIDs" value="<%= QuantityData._id %>">
                                    <p class="details">PRICE DETAILS (<span><%= cartProductDetails.length %></span> item)</p>
                                    <div class="details-line"></div>
                                    <div style="margin-top: 15px;">
                                        <!-- calculate first total price(total MRP) -->
                                        <div class="total-price">
                                            <p>Total MRP:</p>
                                            <% let totalPrice = 0; %>

                                            <% cartProductDetails.forEach(product => { %>
                                                <% totalPrice += parseFloat(product.pDetails[0].firstPrice) * product.userAddedQuantity; %>
                                            <% }); %>

                                            <p style="font-weight: lighter;" class="tPrice">₹<%= totalPrice %></p>

                                        </div>
                                        <!-- calculate first total price(total MRP) -->

                                        
                                        <!-- total discount -->
                                        <% let totalDiscount = 0; %>

                                        <% cartProductDetails.forEach(product => { %>
                                            <!-- testin -->

                                            <% let discountPercentage = 0 %>
                                            <% if(product.pDetails[0].productofferDiscount && product.pDetails[0].categoryofferDiscount){ %>
                                                <% let finalizeDisc = product.pDetails[0].productofferDiscount > product.pDetails[0].categoryofferDiscount ? product.pDetails[0].productofferDiscount : product.pDetails[0].categoryofferDiscount %>
                                                <%  discountPercentage = finalizeDisc + product.pDetails[0].discount %>
                             
                                            <% }else if(product.pDetails[0].productofferDiscount){ %>
                                                <% discountPercentage = product.pDetails[0].productofferDiscount + product.pDetails[0].discount %>
                                            <% }else if(product.pDetails[0].categoryofferDiscount){ %>
                                                <% discountPercentage = product.pDetails[0].categoryofferDiscount + product.pDetails[0].discount %>
                                            <% }else{ %>
                                                <%  discountPercentage = product.pDetails[0].discount %>
                                            <% } %>

                                            <% let discInNums = (product.pDetails[0].firstPrice * discountPercentage) /100 %>
                                            <% let productPrice = product.pDetails[0].firstPrice - discInNums %>
                                            

                                            <% const productPricefirst = product.pDetails[0].firstPrice %>
                                            <% const productQuantity = product.userAddedQuantity %>
                                            

                                            <%# const discountPercentage = product.pDetails[0].discount %>
                                            <%# const productPrice = product.pDetails[0].lastPrice %>
                                            <%# const productPricefirst = product.pDetails[0].firstPrice %>
                                            <%# const productQuantity = product.userAddedQuantity %>

                                            <% const productDiscount = ((productPricefirst - productPrice) * product.userAddedQuantity)  %>
                                            <% totalDiscount += productDiscount; %>
                                            <% totalDiscount = Math.trunc(totalDiscount) %>





                                            <!-- testin -->
                                        <% }); %>

                                        <div class="total-price">
                                            <p class="dis-txt">Discount on MRP:</p>
                                            <p class="dis-price" style="color: #03a685;">-₹<%= totalDiscount %></p>
                                        </div>
                                        <!-- /total discount -->

                                        

                                        <div class="total-price">
                                            <p class="shipping-txt">Shipping:</p>
                                            <p class="free-txt" style="color: #03a685;">Free</p>
                                        </div>
                                        
                                        
                                        
                                        
                                        <!-- calculate last total price(total MRP) -->
                                        <div style="font-weight: bold;" class="total-price">
                                            <p>Total Amount:</p>
                                            <!-- <p class="tPrice"> QuantityData.price * QuantityData.userAddedQuantity </p> -->
                                            <%# let totalLAstPrice = 0; %>

                                            <%# cartProductDetails.forEach(product => { %>
                                                <%# console.log(product.pDetails[0].firstPrice * product.userAddedQuantity); %>
                                                <%# totalLAstPrice = (product.pDetails[0].firstPrice * product.userAddedQuantity)  - totalDiscount %>
                                            <%# }); %>
                                            <p class="tPrice">₹<%= totalPrice - totalDiscount %></p>

                                            <!-- <p class="tPrice">₹<%#= totalLAstPrice %></p> -->

                                        </div>
                                        <!-- calculate last total price(total MRP) -->
                                    </div>
                                    
                                    <div class="coupon-container" style="visibility: hidden; display: flex;align-items: center;justify-content: center;">
                                        <p class="coupon-code">Coupon code</p>
                                        <button type="submit" class="apply-button">Apply</button>
                                    </div>
                                    
                                    
                                    <div style="text-align: center;">
                                            <% let BtnOfRemoveProduct = true; %>
                                            <% let BtnOfOutOfStock = true; %>
                                            <% for(let i=0; i<cartProductDetails.length; i++) { %>
                                                <% if(cartProductDetails[i].pDetails[0].quantity == 0 ){ %>
                                                    <% BtnOfOutOfStock = false; %>
                                                <% } else if (cartProductDetails[i].userAddedQuantity > cartProductDetails[i].pDetails[0].quantity) { %> 
                                                    <% BtnOfRemoveProduct = false; %>
                                                <% }%>
                                            <% } %>
                                            
                                                <!-- **********user add more qty than available qty********* -->
                                            <% if (BtnOfRemoveProduct == false) { %>
                                                <button  onclick="removePopup()" class="final-btn"  type="submit">Proceed.</button>
                                                <!-- **********/user add more qty than available qty********* -->
                                                <!-- **********out of stock********* -->
                                            <% } else if (BtnOfOutOfStock == false) { %>
                                                <button id="finalProceedBtn"  onclick="outofStockPopup()" class="final-btn"  type="submit">Proceed</button>
                                                <!-- <p>oo</p> -->
                                                <!-- **********/out of stock********* -->
                                            <% } else { %>
                                                <a href="/checkout-address" class="final-btn-link"><button class="final-btn"  type="submit">Proceed</button></a>
                                            <% } %>
                                            
                                    </div>
                                <!-- </form> -->
                            </div> 
                        </div>
                    </div>
                    <% }else{ %>
                        <div class="empty-cartSection">
                            <img class="emptyCart-img"  src="/img/emptyBag.png" alt="">
                            <p class="first-text">Hey, it feels so light!</p>
                            <p class="text">There is nothing in your bag.Let's add some items.</p>
                            <a class="shop-button" href="/">Shop now</a>
                        </div>
                        
                        
                    <% } %>
                </div>
            </div>
        </div>
    </main>
    <!-- /main section  --> 


    <!-- footer section -->
    <footer class="footer-section m-0" style="overflow-x: hidden;">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="last-section">

                        <p class="logo-text">Time Trove</p>

                        <div class="left-texts">
                            <p class="bold-text1">Customer Service</p>
                            <i class="fa-brands fa-whatsapp wtsp-icon"></i>
                            <i class=" fa-regular fa-envelope email-icon"></i>
                            <ul class="links1">
                                <li class="left-subtexts">+91 8756575677</li>
                                <li class="left-subtexts">(Mon-Fri,9:00am - 5:00pm)</li>
                                <li class="email left-subtexts" style="margin-top:12px;"><a class="links" href="#">tt@timetrove.com</a></li>
                            </ul>
                        </div>
                        
                        <div class="right-texts" style="text-decoration: none;">
                            <p class="bold-text2">Product Help</p>
                            <ul class="links2 p-0">
                                <li class="right-subtexts"><a href="#" class="links">Return and Cancellation<br>Policy</a></li>
                                <li class="right-subtexts s-policy"style="margin-top:12px;" >
                                    <a href="#" class="links">Shipping & delivery Policy</a></li>
                            </ul>
                        </div>

                        <div class="footer-icons">
                            <i class="fa-brands fa-facebook-f"></i>
                            <i class="fa-brands fa-instagram"></i>
                            <i class="fa-brands fa-twitter"></i>
                            <i class="fa-brands fa-youtube"></i>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </footer> 
    <!-- /footer section -->




    <!-- quantity script -->

    <script>
        function updateQuantity(change, productId) {
            var quantityInput = $('#quantity_' + productId);
            var newQuantity = parseInt(quantityInput.val()) + change;
            console.log(productId);
    
            if (newQuantity >= 1) {
    
                $.ajax({
                    type: 'POST',
                    url: '/update-cart-quantity',
                    data: {
                        productId: productId,
                        quantity: newQuantity
                    },
                    success: function (response) {
                        
                        //update the quantity input field with the new quantity
                        quantityInput.val(newQuantity);


                        console.log('Response from server:', response);
                    
                    
                        
                         if (response?.error) {
                            location.reload();
                            // If there's an error message, display it
                            alert('Quantity limit reached. Please adjust.')
                            document.getElementById('finalProceedBtn').disabled = true;
    
                            // Store the disabled state in local storage
                            localStorage.setItem('finalProceedBtnDisabled', 'true');  
                            return;
                        }

                        $( "#payment-box" ).load( "/shopping-cart #payment-box" );     //reload right section
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.log('error',jqXHR, textStatus, errorThrown);
                        console.error('Error:', textStatus, errorThrown);
                        // Handle the error here
                        // For example, show an error message to the user
                        alert('An error occurred while applying the coupon. Please try again.');
                    }
                });
            }
        }
    </script>
    
    <!-- end of quantity script -->



    

    <!-- script for total price calculation -->
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <script>
        const form = document.querySelectorAll('.quantity-form');

        form.forEach(each => {
            each.addEventListener('submit', (e) => {
                e.preventDefault();
                const productId = each.getAttribute('data-productId');
                var quantityInput = $('#quantity_' + productId);
                var newQuantity = parseInt(quantityInput.val());
                console.log('here');
    
            if (newQuantity >= 1) {
    
                $.ajax({
                    type: 'POST',
                    url: '/update-cart-quantity',
                    data: {
                        productId: productId,
                        quantity: newQuantity
                    },
                    success: function (response) {
                        location.reload();
                        // Handle success, if needed
                    },
                    error: function (error) {
                        // Handle error, if needed
                    }
                });
            }
            })
        })
        function calculateTotalPrice(cartProductDetails, QuantityData) {
            let totalPrice = 0;
    
            cartProductDetails.forEach(product => {
                const quantityData = QuantityData.find(item => item.productId === product._id);
                const productQuantity = quantityData ? parseInt(quantityData.userAddedQuantity) : 0;
                const productPrice = parseFloat(product.price); // Assuming price is a string, convert it to a float if needed
    
                totalPrice += productQuantity * productPrice;
            });
    
            return totalPrice.toFixed(2); // Adjust the precision as needed
        }
    </script>
        <!-- end of total price calculation script-->

    
    

        








    <!-- search box- clear input field after performing operations -->
    <script>
        // Function to clear the search input field
        function clearSearchInput() {
            // Select the input field by its ID
            var searchInput = document.getElementById('searchInput');
            // Clear the input field
            searchInput.value = '';
        }

        //Clear the search input field after 5 seconds
        setTimeout(clearSearchInput, 1000);
    </script>
    <!-- search box- clear input field after performing operations -->


    <!-- search box main function-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        $(document).ready(function() {
            $('#searchInput').on('input', function() {
                const query = $(this).val();
                if (query.length >= 1) { // Only search if the query is at least 3 characters long
                    $.ajax({
                        url: '/search', // Adjust the URL as necessary
                        type: 'GET',
                        data: { q: query },
                        success: function(products) {
                            // Clear the previous search results
                            $('.search-results').empty();
    
                            // Render the new search results
                            products.forEach(product => {
                                // Create a new div for the product result
                                const productDiv = $('<div class="product-result"></div>');
    
                                // Append the product details to the div
                                productDiv.append(`
                                    <h6>${product.productName}</h6>
                                    <p>${product.productDescription}</p>
                                    <img src="${product.images[0]}" alt="${product.productName}">
                                `);
    
                                // Attach a click event handler to the div
                                productDiv.on('click', function() {
                                    // Redirect to the product details page, passing the product's ID as a parameter
                                    window.location.href = `/single-product/${product._id}`;
                                });
    
                                // Append the div to the search results container
                                $('.search-results').append(productDiv);
                            });
                            $('.search-results').show(); // Ensure the search results are visible

                        },
                        error: function(error) {
                            console.error('Error fetching search results:', error);
                        }
                    });
                }
            });
    
            // Define the hideSearchResults function
            function hideSearchResults() {
                $('.search-results').empty().hide(); // Clear and hide the search results
            }
    
            // Listen for click events on the document
            $(document).on('click', function(event) {
                // Check if the click was outside the search box and search results container
                if (!$(event.target).closest('.search-box, .search-results').length) {
                    // Hide the search results
                    hideSearchResults();
                }
            });
        });
    </script>
    <!-- search box main function-->


    <!-- search box close and submit btn activation js-->
    <script>
        document.querySelector('.search').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default action of the link
            var searchBox = document.querySelector('.search-box');
            searchBox.style.display = searchBox.style.display === 'none' ? 'block' : 'none';
        });

        document.querySelector('.search-close').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default action of the button
            document.querySelector('.search-box').style.display = 'none';
            hideSearchResults(); 
        });

        document.querySelector('.search-submit').addEventListener('click', function(event) {
            event.preventDefault(); // Prevent the default action of the button
            var searchInput = document.querySelector('.search-input').value;
            console.log('Search submitted:', searchInput);
            // Here you can add the functionality to perform the search
        });

        function hideSearchResults() {
            $('.search-results').empty().hide(); // Clear and hide the search results
        }
    </script>
        <!-- search box js-->







     <!-- confirmation for remove product from cart -->
     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

     <script>
         async function confirmDelete(event) {
             event.preventDefault();
             
             const result = await Swal.fire({
                 title: 'Are you sure?',
                 // text: 'You won\'t be able to revert this!',
                 icon: 'warning',
                 showCancelButton: true,
                 confirmButtonColor: '#3085d6',
                 cancelButtonColor: '#d33',
                 confirmButtonText: 'Yes, remove product!'
             });

             if (result.isConfirmed) {
                 // Continue with form submission
                 event.target.submit();
             } else {
                 // Cancel form submission
                 Swal.fire('Cancelled');
             }
         }
     </script>

    <!-- /confirmation for remove product from cart -->
   
    

    <script>
        function removePopup(){
            alert('decrease qty or remove product from cart')
        }

        function outofStockPopup(){
            alert('remove out of stock product to proceed')
        }
    </script>








    
  




    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Qqd/EHpFnp6bsQz46erFbPaD8npf4lG8SXfM49cJL/9aG4Zg/YU5dF2DLgsP4LS" crossorigin="anonymous"></script>

</body>
</html>